<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Migration Admin - √âtape par √©tape</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .pending { background: #f8f9fa; border-color: #dee2e6; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .credentials { background: #fff3cd; padding: 15px; border: 1px solid #ffeaa7; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>üîß Migration du Syst√®me d'Administration NZELA</h1>
    <p>Cette interface vous permet d'ex√©cuter la migration √©tape par √©tape pour √©viter les erreurs.</p>
    
    <div id="step1" class="step pending">
        <h3>√âtape 1: Ajouter colonne 'role' √† la table users</h3>
        <button onclick="runStep(1)">Ex√©cuter √©tape 1</button>
        <div id="result1"></div>
    </div>
    
    <div id="step2" class="step pending">
        <h3>√âtape 2: Ajouter colonne 'last_activity' √† la table users</h3>
        <button onclick="runStep(2)" disabled>Ex√©cuter √©tape 2</button>
        <div id="result2"></div>
    </div>
    
    <div id="step3" class="step pending">
        <h3>√âtape 3: Cr√©er le super administrateur</h3>
        <button onclick="runStep(3)" disabled>Ex√©cuter √©tape 3</button>
        <div id="result3"></div>
    </div>
    
    <div id="step4" class="step pending">
        <h3>√âtape 4: Ajouter colonne 'assigned_to' aux signalements</h3>
        <button onclick="runStep(4)" disabled>Ex√©cuter √©tape 4</button>
        <div id="result4"></div>
    </div>
    
    <div id="step5" class="step pending">
        <h3>√âtape 5: Ajouter colonne 'admin_notes' aux signalements</h3>
        <button onclick="runStep(5)" disabled>Ex√©cuter √©tape 5</button>
        <div id="result5"></div>
    </div>
    
    <div id="credentials" class="credentials" style="display: none;">
        <h3>üéâ Migration termin√©e!</h3>
        <p><strong>Identifiants administrateur cr√©√©s:</strong></p>
        <p><strong>Email:</strong> admin@nzela.local</p>
        <p><strong>Mot de passe:</strong> admin123</p>
        <p><em>‚ö†Ô∏è Changez ce mot de passe en production!</em></p>
    </div>

    <script>
        async function runStep(stepNumber) {
            const button = document.querySelector(`#step${stepNumber} button`);
            const result = document.getElementById(`result${stepNumber}`);
            const stepDiv = document.getElementById(`step${stepNumber}`);
            
            button.disabled = true;
            button.textContent = 'Ex√©cution...';
            result.innerHTML = '';
            
            try {
                const response = await fetch(`step-by-step-migration.php?step=${stepNumber}`);
                const data = await response.json();
                
                if (data.success) {
                    stepDiv.className = 'step success';
                    result.innerHTML = `<p>‚úÖ ${data.message}</p>`;
                    
                    // Activer l'√©tape suivante
                    if (data.next_step && data.next_step !== 'done') {
                        const nextButton = document.querySelector(`#step${data.next_step} button`);
                        if (nextButton) nextButton.disabled = false;
                    }
                    
                    // Si c'est la derni√®re √©tape
                    if (data.next_step === 'done') {
                        // Ex√©cuter automatiquement l'√©tape finale
                        setTimeout(() => runStep('done'), 1000);
                    }
                    
                    // Afficher les identifiants si disponibles
                    if (data.admin_credentials) {
                        document.getElementById('credentials').style.display = 'block';
                    }
                } else {
                    stepDiv.className = 'step error';
                    result.innerHTML = `<p>‚ùå Erreur: ${data.error || data.details}</p>`;
                    button.disabled = false;
                    button.textContent = 'R√©essayer';
                }
            } catch (error) {
                stepDiv.className = 'step error';
                result.innerHTML = `<p>‚ùå Erreur de connexion: ${error.message}</p>`;
                button.disabled = false;
                button.textContent = 'R√©essayer';
            }
        }
        
        // Fonction sp√©ciale pour l'√©tape finale
        async function runStep(step) {
            if (step === 'done') {
                try {
                    const response = await fetch('step-by-step-migration.php?step=done');
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('credentials').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Erreur √©tape finale:', error);
                }
                return;
            }
            
            // Code existant pour les autres √©tapes...
            const button = document.querySelector(`#step${step} button`);
            const result = document.getElementById(`result${step}`);
            const stepDiv = document.getElementById(`step${step}`);
            
            button.disabled = true;
            button.textContent = 'Ex√©cution...';
            result.innerHTML = '';
            
            try {
                const response = await fetch(`step-by-step-migration.php?step=${step}`);
                const data = await response.json();
                
                if (data.success) {
                    stepDiv.className = 'step success';
                    result.innerHTML = `<p>‚úÖ ${data.message}</p>`;
                    
                    // Activer l'√©tape suivante
                    if (data.next_step && data.next_step !== 'done') {
                        const nextButton = document.querySelector(`#step${data.next_step} button`);
                        if (nextButton) nextButton.disabled = false;
                    }
                    
                    // Si c'est la derni√®re √©tape
                    if (data.next_step === 'done') {
                        setTimeout(() => runStep('done'), 1000);
                    }
                } else {
                    stepDiv.className = 'step error';
                    result.innerHTML = `<p>‚ùå Erreur: ${data.error || data.details}</p>`;
                    button.disabled = false;
                    button.textContent = 'R√©essayer';
                }
            } catch (error) {
                stepDiv.className = 'step error';
                result.innerHTML = `<p>‚ùå Erreur de connexion: ${error.message}</p>`;
                button.disabled = false;
                button.textContent = 'R√©essayer';
            }
        }
    </script>
</body>
</html>